<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Roblox åŠ¨æ€å¡å¯†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #0f172a; color: #f8fafc; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        .header { text-align: center; color: #818cf8; margin-bottom: 2rem; font-size: 2rem; }
        .countdown-card { background: #1e293b; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; text-align: center; border-left: 4px solid #f87171; }
        .countdown-text { font-size: 1.2rem; color: #f87171; font-weight: bold; }
        .key-card { background: #1e293b; padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem; text-align: center; min-height: 120px; display: flex; align-items: center; justify-content: center; }
        .key-display { font-size: 1.5rem; font-weight: bold; color: #818cf8; letter-spacing: 2px; cursor: pointer; }
        .btn { width: 100%; padding: 1.2rem; background: #818cf8; color: white; border: none; border-radius: 12px; font-size: 1.1rem; cursor: pointer; transition: all 0.3s; margin-bottom: 1rem; }
        .btn:disabled { background: #64748b; cursor: not-allowed; opacity: 0.7; }
        .tip-text { color: #94a3b8; font-size: 0.9rem; text-align: center; margin-bottom: 0.5rem; }
        .message { text-align: center; font-weight: bold; margin-top: 1rem; min-height: 20px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1 class="header">ğŸ‰ Free Roblox åŠ¨æ€å¡å¯†</h1>

    <div class="countdown-card">
        <p class="countdown-text">ç½‘é¡µå°†åœ¨ <span id="expire-time">300</span> ç§’åå¤±æ•ˆï¼Œè¯·å°½å¿«è·å–å¡å¯†ï¼</p>
    </div>

    <div class="key-card" id="key-container">
        <span class="tip-text">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·å–å¡å¯†</span>
    </div>

    <button class="btn" id="get-key-btn" disabled>ç‚¹å‡»è·å–å…è´¹å¡å¯†</button>

    <p class="tip-text">å¡å¯†æ ¼å¼ï¼šFree-XXXXXXXXXXXXXXXXï¼ˆæ¿€æ´»å16å°æ—¶å†…æœ‰æ•ˆï¼‰</p>
    <p class="tip-text">æ¯ä¸ªé¡µé¢ä»…å¯è·å–1æ¬¡å¡å¯†ï¼Œé‡æ–°è·å–éœ€å®ŒæˆLootLabså¹¿å‘Š</p>
    <div class="message" id="message-box"></div>

    <script>
        // é…ç½®ä¿¡æ¯ï¼ˆå·²å¡«å®Œæ•´ï¼‰
        const SUPABASE_URL = "https://tsbxfqepksspgzmuyywv.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_74klMxblBBRjlOlDhBELlQ_7_7oJsf-";
        const LOOTLABS_LINK = "https://lootdest.org/s?ZzixBxyu"; // ä½ çš„LootLabsçŸ­é“¾
        const ALLOWED_REFERRER = "https://lootdest.org/s?ZzixBxyu"; // å…è®¸çš„æ¥æºé¡µ

        // æ ¸å¿ƒå¸¸é‡
        const PAGE_EXPIRE_SEC = 5 * 60;
        const KEY_PREFIX = "Free";
        const KEY_LENGTH = 16;
        const KEY_VALID_DURATION = 16 * 3600 * 1000;

        // çŠ¶æ€å˜é‡
        let isBtnClicked = false;
        let pageId = Math.random().toString(36).slice(2, 18) + Math.random().toString(36).slice(2, 18);
        let expireTimer = null;
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // æ¥æºéªŒè¯ï¼šä»…å…è®¸ä»LootLabsçŸ­é“¾è¿›å…¥
        function checkReferrer() {
            const referrer = document.referrer; // è·å–ä¸Šä¸€é¡µåœ°å€
            const currentUrl = window.location.href; // å½“å‰å¡å¯†é¡µåœ°å€

            // æƒ…å†µ1ï¼šç›´æ¥æ‰“å¼€å¡å¯†é¡µï¼ˆæ— æ¥æºï¼‰â†’ è·³è½¬LootLabs
            if (!referrer || referrer === "") {
                window.location.href = LOOTLABS_LINK;
                return false;
            }

            // æƒ…å†µ2ï¼šæ¥æºä¸æ˜¯æŒ‡å®šçš„LootLabsçŸ­é“¾ â†’ è·³è½¬LootLabs
            if (!referrer.includes(ALLOWED_REFERRER) && !currentUrl.includes(ALLOWED_REFERRER)) {
                window.location.href = LOOTLABS_LINK;
                return false;
            }

            // éªŒè¯é€šè¿‡ï¼Œå¯ç”¨æŒ‰é’®
            document.getElementById("get-key-btn").disabled = false;
            showMessage("æ¥æºéªŒè¯é€šè¿‡ï¼Œå¯è·å–å¡å¯†", "success");
            return true;
        }

        // ç”Ÿæˆå”¯ä¸€å¡å¯†
        async function generateUniqueKey() {
            let key;
            do {
                const randomNum = Math.random().toString().substring(2, 2 + KEY_LENGTH).padEnd(KEY_LENGTH, "0");
                key = `${KEY_PREFIX}-${randomNum}`;
                const { data: existingKey } = await supabase
                    .from("keys")
                    .select("key_value")
                    .eq("key_value", key)
                    .single();
                if (!existingKey) break;
            } while (true);
            return key;
        }

        // å¤åˆ¶å¡å¯†
        function copyKey(key) {
            navigator.clipboard.writeText(key)
                .then(() => showMessage(`å¡å¯†å·²å¤åˆ¶ï¼š${key}`, "success"))
                .catch(() => showMessage("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶", "error"));
        }

        // æ˜¾ç¤ºæç¤º
        function showMessage(text, type) {
            const msgBox = document.getElementById("message-box");
            msgBox.textContent = text;
            msgBox.className = `message ${type}`;
            setTimeout(() => msgBox.className = "message", 5000);
        }

        // é¡µé¢åˆå§‹åŒ–
        window.onload = async () => {
            const btn = document.getElementById("get-key-btn");
            const keyContainer = document.getElementById("key-container");
            const expireEl = document.getElementById("expire-time");

            // ç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œæ¥æºéªŒè¯
            const isVerified = checkReferrer();
            if (!isVerified) return;

            // ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–5åˆ†é’Ÿå€’è®¡æ—¶
            let remainSec = PAGE_EXPIRE_SEC;
            expireTimer = setInterval(() => {
                remainSec--;
                expireEl.textContent = remainSec;
                if (remainSec <= 0) {
                    clearInterval(expireTimer);
                    window.location.href = LOOTLABS_LINK; // è¶…æ—¶è·³è½¬LootLabs
                }
            }, 1000);

            // ç¬¬ä¸‰æ­¥ï¼šç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            btn.addEventListener("click", async () => {
                if (isBtnClicked) {
                    showMessage("å½“å‰é¡µé¢å·²è·å–è¿‡å¡å¯†ï¼", "error");
                    return;
                }

                isBtnClicked = true;
                btn.disabled = true;
                keyContainer.innerHTML = '<span class="tip-text">æ­£åœ¨ç”Ÿæˆå¡å¯†...</span>';

                try {
                    // æ£€æŸ¥å½“å‰pageIdæ˜¯å¦å·²ç”Ÿæˆå¡å¯†
                    const { data: existingPageKey } = await supabase
                        .from("keys")
                        .select("key_value")
                        .eq("page_id", pageId)
                        .single();
                    if (existingPageKey) {
                        keyContainer.innerHTML = `<span class="key-display" onclick="copyKey('${existingPageKey.key_value}')">${existingPageKey.key_value}</span>`;
                        showMessage("å½“å‰é¡µé¢å¡å¯†å·²ç”Ÿæˆï¼", "success");
                        return;
                    }

                    // ç”Ÿæˆå¹¶å­˜å‚¨æ–°å¡å¯†
                    const newKey = await generateUniqueKey();
                    const { data: insertedKey, error } = await supabase
                        .from("keys")
                        .insert([{
                            key_value: newKey,
                            status: "unused",
                            activate_time: 0,
                            valid_duration: KEY_VALID_DURATION,
                            page_id: pageId
                        }])
                        .select();

                    if (error) throw error;
                    keyContainer.innerHTML = `<span class="key-display" onclick="copyKey('${newKey}')">${newKey}</span>`;
                    showMessage("å¡å¯†ç”ŸæˆæˆåŠŸï¼æ¿€æ´»å16å°æ—¶å†…æœ‰æ•ˆ", "success");
                } catch (err) {
                    keyContainer.innerHTML = '<span class="tip-text">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·å–å¡å¯†</span>';
                    showMessage(`å¡å¯†ç”Ÿæˆå¤±è´¥ï¼š${err.message}`, "error");
                    console.error("ç”Ÿæˆå¤±è´¥è¯¦æƒ…ï¼š", err);
                }
            });
        };

        // é¡µé¢å…³é—­æ¸…ç†å®šæ—¶å™¨
        window.onbeforeunload = () => {
            if (expireTimer) clearInterval(expireTimer);
        };
    </script>
</body>
</html>

