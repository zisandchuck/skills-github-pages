<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox Key System - API版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        .step-container {
            display: none;
            background: #2d2d2d;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .step-container.active {
            display: block;
        }
        h1 {
            color: #4ade80;
            margin-bottom: 20px;
            font-size: 22px;
        }
        a {
            display: inline-block;
            background: #3b82f6;
            color: #fff;
            padding: 12px 20px;
            border-radius: 6px;
            text-decoration: none;
            margin-bottom: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        a:hover {
            background: #2563eb;
        }
        button {
            background: #10b981;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }
        button:hover {
            background: #059669;
        }
        button:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }
        #key-display {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 18px;
            word-break: break-all;
            color: #4ade80;
            animation: fadeIn 0.3s ease;
        }
        .error-tip {
            color: #ef4444;
            margin-top: 10px;
            font-size: 14px;
        }
        .loading {
            color: #60a5fa;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        .tip-text {
            color: #9ca3af;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- 步骤1：Lootslab广告 -->
    <div id="step1" class="step-container active">
        <h1>步骤1：完成Lootslab广告验证</h1>
        <a id="ad1-link" href="https://loot-link.com/s?G02Nvp4U" target="_blank">点击打开Lootslab广告</a>
        <p class="tip-text">完成广告后点击下方按钮校验</p>
        <button onclick="checkStep(1)">校验广告完成状态</button>
        <div class="loading" id="loading1">正在校验广告状态...</div>
        <div class="error-tip" id="error1"></div>
    </div>

    <!-- 步骤2：Linkvertise广告 -->
    <div id="step2" class="step-container">
        <h1>步骤2：完成Linkvertise广告验证</h1>
        <a id="ad2-link" href="你的Linkvertise Step2广告链接" target="_blank">点击打开Linkvertise广告</a>
        <p class="tip-text">完成广告后点击下方按钮校验</p>
        <button onclick="checkStep(2)">校验广告完成状态</button>
        <div class="loading" id="loading2">正在校验广告状态...</div>
        <div class="error-tip" id="error2"></div>
    </div>

    <!-- 步骤3：Linkvertise广告 -->
    <div id="step3" class="step-container">
        <h1>步骤3：完成Linkvertise广告验证</h1>
        <a id="ad3-link" href="你的Linkvertise Step3广告链接" target="_blank">点击打开Linkvertise广告</a>
        <p class="tip-text">完成广告后点击下方按钮校验</p>
        <button onclick="checkStep(3)">校验广告完成状态</button>
        <div class="loading" id="loading3">正在校验广告状态...</div>
        <div class="error-tip" id="error3"></div>
    </div>

    <!-- 卡密展示区域 -->
    <div id="key-display"></div>

    <script>
        // 配置项
        const WORKERS_URL = "https://r.check868.workers.dev"; // 你的Workers域名
        const LINKVERTISE_AD2_URL = "你的Linkvertise Step2广告链接"; // 替换为实际链接
        const LINKVERTISE_AD3_URL = "你的Linkvertise Step3广告链接"; // 替换为实际链接

        // 初始化广告链接
        window.onload = function() {
            document.getElementById("ad2-link").href = LINKVERTISE_AD2_URL;
            document.getElementById("ad3-link").href = LINKVERTISE_AD3_URL;
        };

        // 获取设备HWID
        function getHWID() {
            if (localStorage.getItem("hwid")) {
                return localStorage.getItem("hwid");
            }
            const hwid = Math.random().toString(36).slice(2, 18) + Date.now().toString(36);
            localStorage.setItem("hwid", hwid);
            return hwid;
        }

        // 获取Roblox ID（从URL参数）
        const urlParams = new URLSearchParams(window.location.search);
        const ROBLOX_ID = urlParams.get("robloxId") || "未知用户";

        // 校验广告完成状态
        async function checkStep(step) {
            const hwid = getHWID();
            const loadingEl = document.getElementById(`loading${step}`);
            const errorEl = document.getElementById(`error${step}`);
            
            // 重置状态
            errorEl.textContent = "";
            loadingEl.style.display = "block";

            try {
                const response = await fetch(`${WORKERS_URL}/verify-ad?step=${step}&hwid=${hwid}&robloxId=${ROBLOX_ID}`);
                const result = await response.text();
                loadingEl.style.display = "none";

                if (response.ok) {
                    if (step === 3) {
                        generateKey(); // 生成卡密
                    } else {
                        // 跳转到下一步
                        document.getElementById(`step${step}`).classList.remove("active");
                        document.getElementById(`step${step+1}`).classList.add("active");
                        window.scrollTo(0, 0);
                        alert(`Step${step}广告验证成功，已跳转到Step${step+1}`);
                    }
                } else {
                    errorEl.textContent = `验证失败：${result}`;
                }
            } catch (err) {
                loadingEl.style.display = "none";
                errorEl.textContent = `网络错误：${err.message}`;
            }
        }

        // 生成卡密
        async function generateKey() {
            const hwid = getHWID();
            const keyDisplay = document.getElementById("key-display");
            keyDisplay.textContent = "正在生成卡密...";

            try {
                const response = await fetch(`${WORKERS_URL}/generate-key`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        hwid: hwid,
                        robloxId: ROBLOX_ID
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    keyDisplay.innerHTML = `
                        <h2>卡密生成成功！</h2>
                        <p>你的卡密（12小时内有效）：</p>
                        <strong style="font-size: 20px; letter-spacing: 1px;">${data.key}</strong>
                        <p style="margin-top: 10px;">卡密仅可使用一次，有效期12小时</p>
                        <p style="margin-top: 5px; color: #9ca3af;">复制卡密返回Roblox完成验证</p>
                    `;
                    // 隐藏所有步骤
                    document.querySelectorAll(".step-container").forEach(el => el.style.display = "none");
                } else {
                    keyDisplay.textContent = `生成失败：${data.message || "请完成所有广告步骤"}`;
                }
            } catch (err) {
                keyDisplay.textContent = `生成失败：${err.message}`;
            }
        }
    </script>
</body>
</html>

