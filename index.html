<script>
const API = "https://roblox-auth.check868.workers.dev";

let pageToken = null;

// 页面加载：先换 pageToken
(async () => {
  try {
    const res = await fetch(API + "/page");
    const data = await res.json();
    if (!data.ok) throw "fail";
    pageToken = data.pageToken;
  } catch {
    alert("页面初始化失败，请重新从广告进入");
  }
})();

document.getElementById("genBtn").onclick = async () => {
  if (!pageToken) {
    alert("页面已过期，请重新从广告进入");
    return;
  }

  const res = await fetch(API + "/generate", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ pageToken })
  });

  const data = await res.json();
  if (!data.ok) {
    alert(data.msg);
    return;
  }

  document.getElementById("codeDisplay").style.display = "block";
  document.getElementById("codeDisplay").innerText =
    "你的卡密：" + data.code;
};
</script>

